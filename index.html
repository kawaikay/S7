<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e40af">
    <title>Site Safety Inspection | åœ°ç›¤å®‰å…¨æª¢æŸ¥ç³»çµ±</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --primary: #2563eb; --primary-dark: #1e40af; --danger: #dc2626; --warning: #f59e0b; --success: #16a34a; --gray: #6b7280; --light: #f3f4f6; --contractor: #f59e0b; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang TC', 'Hiragino Sans TC', 'Microsoft JhengHei', sans-serif; background: #f8fafc; padding: 0; line-height: 1.5; -webkit-font-smoothing: antialiased; }
        .app-container { max-width: 100%; min-height: 100vh; background: white; position: relative; }

        /* Login Styles */
        .login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .login-box { background: white; padding: 32px; border-radius: 16px; width: 100%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .login-title { font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 8px; color: #1f2937; }
        .login-subtitle { text-align: center; color: #6b7280; margin-bottom: 24px; font-size: 0.875rem; }
        .login-field { margin-bottom: 16px; }
        .login-label { display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 6px; }
        .login-input { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: all 0.2s; }
        .login-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .role-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .role-option { padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .role-option.selected { border-color: #3b82f6; background: #eff6ff; }
        .role-icon { font-size: 2rem; margin-bottom: 8px; }
        .role-name { font-weight: 600; font-size: 0.875rem; }
        .btn-login { width: 100%; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-login:hover { background: #1d4ed8; }
        .login-error { color: #dc2626; font-size: 0.875rem; margin-top: 12px; text-align: center; display: none; }

        /* Sync Status */
        .sync-status { position: fixed; top: 70px; right: 16px; padding: 8px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; z-index: 1000; display: flex; align-items: center; gap: 6px; transition: all 0.3s; }
        .sync-status.online { background: #d1fae5; color: #065f46; }
        .sync-status.offline { background: #fee2e2; color: #991b1b; }
        .sync-status.syncing { background: #dbeafe; color: #1e40af; }
        .user-badge { position: fixed; top: 70px; left: 16px; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; z-index: 1000; background: #1e40af; color: white; }

        /* App Header */
        .app-header { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 16px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .app-header h1 { font-size: 1.25rem; font-weight: 700; margin-bottom: 4px; }
        .app-header p { font-size: 0.875rem; opacity: 0.9; }
        .header-actions { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); display: flex; gap: 8px; }
        .header-btn { width: 36px; height: 36px; border: none; background: rgba(255,255,255,0.2); color: white; border-radius: 8px; cursor: pointer; font-size: 1.125rem; display: flex; align-items: center; justify-content: center; }

        /* Progress & Mode */
        .progress-bar { background: white; padding: 12px 16px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px; }
        .progress-text { font-size: 0.875rem; color: #374151; font-weight: 500; white-space: nowrap; }
        .progress-track { flex: 1; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #1d4ed8); border-radius: 4px; transition: width 0.3s ease; width: 0%; }
        .mode-toggle { background: white; padding: 12px 16px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .mode-btn { padding: 8px 16px; border: 2px solid #e5e7eb; background: white; border-radius: 20px; font-size: 0.875rem; font-weight: 500; color: #6b7280; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .mode-btn.active { background: #3b82f6; border-color: #3b82f6; color: white; }

        /* Categories */
        .category-grid { padding: 16px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .category-card { background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
        .category-card:active { transform: scale(0.98); }
        .category-card.selected { border-color: #3b82f6; background: #eff6ff; }
        .category-card.completed { border-color: #16a34a; background: #f0fdf4; }
        .category-icon { font-size: 2rem; margin-bottom: 8px; }
        .category-name { font-size: 0.875rem; font-weight: 600; color: #1f2937; margin-bottom: 4px; }
        .category-count { font-size: 0.75rem; color: #6b7280; }
        .check-mark { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: #16a34a; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 0.875rem; }
        .category-card.completed .check-mark { display: flex; }

        /* Inspection View */
        .inspection-view { display: none; padding: 16px; padding-bottom: 100px; }
        .inspection-view.active { display: block; }
        .nav-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .back-btn { width: 40px; height: 40px; border: none; background: #f3f4f6; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.25rem; }
        .nav-title { flex: 1; font-size: 1.125rem; font-weight: 700; color: #1f2937; }

        /* Checklist Item */
        .checklist-item { background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; page-break-inside: avoid; }
        .item-header { padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .item-number { display: inline-block; width: 28px; height: 28px; background: #3b82f6; color: white; border-radius: 50%; text-align: center; line-height: 28px; font-size: 0.875rem; font-weight: 700; margin-right: 8px; }
        .item-title { font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 8px; line-height: 1.4; }
        .item-subtitle { font-size: 0.875rem; color: #6b7280; }
        .badges { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge.critical { background: #fee2e2; color: #dc2626; }
        .badge.high { background: #ffedd5; color: #ea580c; }
        .badge.medium { background: #fef3c7; color: #d97706; }
        .badge.freq { background: #e0e7ff; color: #4f46e5; }

        /* Status */
        .status-section { padding: 16px; border-bottom: 1px solid #e5e7eb; }
        .status-label { font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 12px; display: block; }
        .status-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .status-option { padding: 12px; border: 2px solid #e5e7eb; background: white; border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .status-option.selected { border-width: 3px; }
        .status-option.pass.selected { border-color: #16a34a; background: #f0fdf4; }
        .status-option.fail.selected { border-color: #dc2626; background: #fef2f2; }
        .status-option.na.selected { border-color: #6b7280; background: #f9fafb; }
        .status-icon { font-size: 1.5rem; margin-bottom: 4px; }
        .status-text { font-size: 0.875rem; font-weight: 600; }

        /* Photos */
        .photo-section { padding: 16px; background: #fafafa; }
        .photo-label { font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .photo-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px; }
        .photo-box { aspect-ratio: 4/3; background: white; border: 2px dashed #d1d5db; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
        .photo-box.has-image { border-style: solid; border-color: #3b82f6; }
        .photo-box input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }
        .photo-placeholder { text-align: center; color: #9ca3af; pointer-events: none; }
        .photo-icon { font-size: 2rem; margin-bottom: 4px; }
        .photo-text { font-size: 0.75rem; font-weight: 500; }
        .photo-preview { position: absolute; inset: 0; background-size: cover; background-position: center; display: none; }
        .photo-box.has-image .photo-preview { display: block; }
        .photo-box.has-image .photo-placeholder { display: none; }
        .remove-photo { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background: rgba(220, 38, 38, 0.9); color: white; border: none; border-radius: 50%; font-size: 1rem; cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 100; }
        .photo-box.has-image .remove-photo { display: flex; }
        .photo-caption { font-size: 0.75rem; color: #6b7280; text-align: center; margin-top: 4px; }

        /* Remarks & Sections */
        .remarks-section { padding: 16px; border-top: 1px solid #e5e7eb; }
        .remarks-field { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; resize: vertical; min-height: 80px; font-family: inherit; }
        .remarks-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .inspector-section { background: #eff6ff; padding: 16px; border-top: 2px solid #3b82f6; }
        .contractor-section { background: #fef3c7; padding: 16px; border-top: 2px solid #f59e0b; }
        .section-label { font-size: 0.875rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .inspector-label { color: #1e40af; }
        .contractor-label { color: #92400e; }

        /* Bottom Actions */
        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 16px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); }
        .btn { flex: 1; padding: 14px 20px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:active { background: #1d4ed8; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:active { background: #e5e7eb; }
        .btn-success { background: #16a34a; color: white; }

        /* Summary */
        .summary-view { display: none; padding: 16px; padding-bottom: 100px; }
        .summary-view.active { display: block; }
        .summary-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .summary-title { font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 16px; }
        .summary-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .stat-box { background: #f9fafb; padding: 16px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; color: #3b82f6; }
        .stat-label { font-size: 0.875rem; color: #6b7280; margin-top: 4px; }
        .issue-list { margin-top: 16px; }
        .issue-item { background: #fef2f2; border-left: 4px solid #dc2626; padding: 12px; border-radius: 8px; margin-bottom: 8px; }
        .issue-title { font-weight: 600; color: #991b1b; font-size: 0.875rem; }
        .issue-category { font-size: 0.75rem; color: #dc2626; margin-top: 4px; }

        /* Info Input */
        .info-input-section { background: white; padding: 16px; border-bottom: 1px solid #e5e7eb; }
        .info-grid { display: grid; gap: 12px; }
        .info-field { display: flex; flex-direction: column; gap: 4px; }
        .info-label { font-size: 0.875rem; font-weight: 600; color: #374151; }
        .info-input { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; font-family: inherit; }
        .info-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .loading-overlay.active { display: flex; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; margin-top: 16px; font-weight: 600; }

        /* Offline Banner */
        .offline-banner { background: #dc2626; color: white; padding: 12px; text-align: center; font-size: 0.875rem; font-weight: 600; display: none; }
        .offline-banner.active { display: block; }
    </style>
</head>
<body>
    <div class="offline-banner" id="offlineBanner">âš ï¸ é›¢ç·šæ¨¡å¼ Offline Mode - æ•¸æ“šå°‡åœ¨é€£ç·šå¾ŒåŒæ­¥</div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-title">ğŸ” Site Safety Inspection</div>
            <div class="login-subtitle">åœ°ç›¤å®‰å…¨æª¢æŸ¥ç³»çµ± v2.0</div>

            <div class="login-field">
                <label class="login-label">é›»éƒµ Email</label>
                <input type="email" class="login-input" id="loginEmail" placeholder="è¼¸å…¥é›»éƒµ...">
            </div>

            <div class="login-field">
                <label class="login-label">å¯†ç¢¼ Password</label>
                <input type="password" class="login-input" id="loginPassword" placeholder="è¼¸å…¥å¯†ç¢¼...">
            </div>

            <div class="login-field">
                <label class="login-label">è§’è‰² Role</label>
                <div class="role-selector">
                    <div class="role-option selected" data-role="inspector" onclick="selectRole('inspector')">
                        <div class="role-icon">ğŸ‘·</div>
                        <div class="role-name">é§åœ°å·¥ç¨‹å¸«<br>RSS Inspector</div>
                    </div>
                    <div class="role-option" data-role="contractor" onclick="selectRole('contractor')">
                        <div class="role-icon">ğŸ—ï¸</div>
                        <div class="role-name">æ‰¿åŒ…å•†<br>Contractor</div>
                    </div>
                </div>
            </div>

            <button class="btn-login" onclick="login()">ç™»å…¥ Login</button>
            <div class="login-error" id="loginError"></div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center;">
                <button class="btn btn-secondary" onclick="offlineMode()" style="width: 100%;">ğŸ“´ é›¢ç·šä½¿ç”¨ Offline Mode</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display: none;">
        <div class="sync-status online" id="syncStatus">
            <span id="syncIcon">ğŸŸ¢</span>
            <span id="syncText">å·²é€£ç·š Online</span>
        </div>
        <div class="user-badge" id="userBadge">ğŸ‘· RSS</div>

        <div class="app-header">
            <h1>ğŸ” Site Safety Inspection</h1>
            <p id="headerSubtitle">é§åœ°å·¥ç¨‹å¸«ä»£è¡¨ Representative from RSS</p>
            <div class="header-actions">
                <button class="header-btn" onclick="syncData()" title="åŒæ­¥ Sync">ğŸ”„</button>
                <button class="header-btn" onclick="logout()" title="ç™»å‡º Logout">ğŸšª</button>
            </div>
        </div>

        <div class="progress-bar">
            <span class="progress-text">é€²åº¦</span>
            <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
            <span class="progress-text" id="progressText">0/15</span>
        </div>

        <div class="mode-toggle">
            <button class="mode-btn active" onclick="showView('select')">é¸æ“‡é …ç›®</button>
            <button class="mode-btn" onclick="showView('inspect')">é€²è¡Œæª¢æŸ¥</button>
            <button class="mode-btn" onclick="showView('summary')">æª¢æŸ¥æ‘˜è¦</button>
        </div>

        <div class="category-grid" id="selectView"></div>

        <div class="inspection-view" id="inspectView">
            <div class="nav-header">
                <button class="back-btn" onclick="showView('select')">â†</button>
                <div class="nav-title" id="inspectTitle">æ¶ˆé˜²å®‰å…¨</div>
            </div>
            <div class="info-input-section">
                <div class="info-grid">
                    <div class="info-field">
                        <label class="info-label">é …ç›®åç¨± Project Name *</label>
                        <input type="text" class="info-input" id="projectName" placeholder="è¼¸å…¥é …ç›®åç¨±...">
                    </div>
                    <div class="info-field">
                        <label class="info-label">æª¢æŸ¥ç·¨è™Ÿ Inspection No.</label>
                        <input type="text" class="info-input" id="inspectionNo" placeholder="è‡ªå‹•ç”Ÿæˆ" readonly>
                    </div>
                    <div class="info-field">
                        <label class="info-label">é§åœ°å·¥ç¨‹å¸«ä»£è¡¨ RSS Rep *</label>
                        <input type="text" class="info-input" id="inspectorName" placeholder="è¼¸å…¥ä»£è¡¨å§“å...">
                    </div>
                    <div class="info-field">
                        <label class="info-label">æ‰¿åŒ…å•†ä»£è¡¨ Contractor Rep *</label>
                        <input type="text" class="info-input" id="contractorName" placeholder="è¼¸å…¥æ‰¿åŒ…å•†ä»£è¡¨...">
                    </div>
                    <div class="info-field">
                        <label class="info-label">æ—¥æœŸ Date *</label>
                        <input type="date" class="info-input" id="inspectionDate">
                    </div>
                    <div class="info-field">
                        <label class="info-label">å¤©æ°£ Weather</label>
                        <input type="text" class="info-input" id="weather" placeholder="è¼¸å…¥å¤©æ°£ç‹€æ³...">
                    </div>
                </div>
            </div>
            <div id="inspectContent"></div>
        </div>

        <div class="summary-view" id="summaryView">
            <div class="summary-card">
                <div class="summary-title">æª¢æŸ¥æ‘˜è¦ Inspection Summary</div>
                <div class="summary-stats">
                    <div class="stat-box"><div class="stat-number" id="totalItems">0</div><div class="stat-label">å·²æª¢æŸ¥é …ç›®</div></div>
                    <div class="stat-box"><div class="stat-number" id="passItems">0</div><div class="stat-label">åˆæ ¼ PASS</div></div>
                    <div class="stat-box"><div class="stat-number" id="failItems">0</div><div class="stat-label">ä¸åˆæ ¼ FAIL</div></div>
                    <div class="stat-box"><div class="stat-number" id="naItems">0</div><div class="stat-label">ä¸é©ç”¨ N/A</div></div>
                </div>
            </div>
            <div class="summary-card" id="issuesCard" style="display: none;">
                <div class="summary-title">ç™¼ç¾çš„å•é¡Œ Issues Found</div>
                <div class="issue-list" id="issueList"></div>
            </div>
            <div class="summary-card">
                <div class="summary-title">å ±å‘Šæ“ä½œ Report Actions</div>
                <div style="display: grid; gap: 10px;">
                    <button class="btn btn-primary" onclick="generateReport('pdf')">ğŸ“„ ç”Ÿæˆ PDF å ±å‘Š</button>
                    <button class="btn btn-secondary" onclick="generateReport('word')">ğŸ“ ç”Ÿæˆ Word æ–‡æª”</button>
                    <button class="btn btn-success" onclick="shareReport()">ğŸ”— åˆ†äº«çµ¦æ‰¿åŒ…å•†</button>
                </div>
            </div>
        </div>

        <div class="bottom-actions" id="bottomActions">
            <button class="btn btn-secondary" onclick="resetInspection()">ğŸ”„ é‡ç½® Reset</button>
            <button class="btn btn-primary" onclick="saveToCloud()">ğŸ’¾ ä¿å­˜ Save</button>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">è™•ç†ä¸­ Processing...</div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        // Initialize Firebase
        let app, auth, database, storage;
        let isFirebaseInitialized = false;

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                storage = firebase.storage();
                isFirebaseInitialized = true;
            }
        } catch (e) {
            console.warn('Firebase init failed:', e);
        }

        // ==================== SERVICE WORKER ====================
        if ('serviceWorker' in navigator) {
            const swCode = `const CACHE_NAME='safety-v1';self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(['/','/index.html'])));});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));});`;
            const blob = new Blob([swCode], {type:'application/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }

        // ==================== DATA ====================
        const inspectionData = {
            fire: { name: "æ¶ˆé˜²å®‰å…¨ / Fire Safety", items: [
                { id: "F1", title: "Fire extinguishers provided and accessible", titleCN: "æ»…ç«ç­’é…ç½®å¦¥ç•¶ä¸¦å¯å–ç”¨", priority: "high", freq: "Daily" },
                { id: "F2", title: "Housekeeping maintained to minimize fire hazards", titleCN: "ä¿æŒæ•´æ½”ä»¥æ¸›å°‘ç«ç½å±éšª", priority: "medium", freq: "Daily" },
                { id: "F3", title: "Fire extinguisher certificate valid and not expired", titleCN: "æ»…ç«ç­’è­‰æ›¸æœ‰æ•ˆä¸”æœªéæœŸ", priority: "critical", freq: "Weekly" },
                { id: "F4", title: "Fire extinguisher properly hung above ground", titleCN: "æ»…ç«ç­’å¦¥å–„æ‡¸æ›æ–¼åœ°é¢ä»¥ä¸Š", priority: "medium", freq: "Daily" },
                { id: "F5", title: "Damaged or defective fire extinguisher replaced", titleCN: "æå£æˆ–æ•…éšœæ»…ç«ç­’å·²æ›´æ›", priority: "high", freq: "Daily" },
                { id: "F6", title: "Fire extinguisher provided at chemical storage area", titleCN: "åŒ–å­¸å“å„²å­˜å€é…ç½®æ»…ç«ç­’", priority: "critical", freq: "Daily" },
                { id: "F7", title: "Fire extinguisher provided at electricity distribution board", titleCN: "é…é›»æ¿é…ç½®æ»…ç«ç­’", priority: "high", freq: "Daily" }
            ]},
            electrical: { name: "é›»æ°£å®‰å…¨ / Electrical Safety", items: [
                { id: "E1", title: "Generators properly earthed", titleCN: "ç™¼é›»æ©Ÿå¦¥å–„æ¥åœ°", priority: "high", freq: "Weekly" },
                { id: "E2", title: "Power cables properly managed", titleCN: "é›»æºç·šå¦¥å–„ç®¡ç†", priority: "high", freq: "Daily" },
                { id: "E3", title: "Waterproof socket of electric arc welding repaired", titleCN: "é›»å¼§ç„Šé˜²æ°´æ’åº§å·²ä¿®å¾©", priority: "critical", freq: "Daily" },
                { id: "E4", title: "No water spillage on top of electric switch box", titleCN: "é›»åˆ¶ç®±é ‚éƒ¨ç„¡æ°´æº¢å‡º", priority: "critical", freq: "Daily" },
                { id: "E5", title: "Water tank relocated to prevent spillage on electrics", titleCN: "æ°´ç®±é‡æ–°æ”¾ç½®é˜²æ­¢é›»æ°£è¨­å‚™å—æ¿•", priority: "critical", freq: "Daily" },
                { id: "E6", title: "Welding equipment properly stored and maintained", titleCN: "ç„Šæ¥è¨­å‚™å¦¥å–„å­˜æ”¾åŠä¿é¤Š", priority: "medium", freq: "Daily" },
                { id: "E7", title: "Defective welding clamp replaced", titleCN: "æå£ç„Šæ¥å¤¾å…·å·²æ›´æ›", priority: "high", freq: "Daily" },
                { id: "E8", title: "Power cables hanged above head level", titleCN: "é›»æºç·šæ‡¸æ›æ–¼é ­éƒ¨é«˜åº¦ä»¥ä¸Š", priority: "high", freq: "Daily" },
                { id: "E9", title: "Power cables not hanged on sharp objects", titleCN: "é›»æºç·šä¸æ‡¸æ›æ–¼å°–éŠ³ç‰©ä»¶ä¸Š", priority: "high", freq: "Daily" },
                { id: "E10", title: "Pre-use inspection conducted for portable power tools", titleCN: "æ‰‹æé›»å‹•å·¥å…·ä½¿ç”¨å‰æª¢æŸ¥", priority: "high", freq: "Daily" }
            ]},
            lifting: { name: "èµ·é‡ä½œæ¥­ / Lifting Operations", items: [
                { id: "L1", title: "Lifting gear properly attached", titleCN: "èµ·é‡è¨­å‚™æ­£ç¢ºé€£æ¥", priority: "critical", freq: "Each Lift" },
                { id: "L2", title: "Shackles have valid certificates and ID marks", titleCN: "å¸æ‰£å…·æœ‰æœ‰æ•ˆè­‰æ›¸åŠæ¨™è­˜", priority: "medium", freq: "Weekly" },
                { id: "L3", title: "Wire slings and shackles properly color-coded", titleCN: "é‹¼çµ²ç¹©åŠå¸æ‰£æ­£ç¢ºé¡è‰²ç·¨ç¢¼", priority: "medium", freq: "Weekly" },
                { id: "L4", title: "Area under crane jib fenced off", titleCN: "åŠè‡‚ä¸‹æ–¹å€åŸŸåœå°", priority: "high", freq: "Daily" },
                { id: "L5", title: "Crane operators trained and competent", titleCN: "èµ·é‡æ©Ÿæ“ä½œå“¡ç¶“éåŸ¹è¨“ä¸¦å…·è³‡æ ¼", priority: "high", freq: "Weekly" },
                { id: "L6", title: "Two different objects not lifted at same time", titleCN: "ä¸åŒç‰©ä»¶ä¸æœƒåŒæ™‚åŠé‹", priority: "critical", freq: "Each Lift" },
                { id: "L7", title: "Certified lifting receptacle used for loose materials", titleCN: "æ•£æ–™ä½¿ç”¨èªè­‰èµ·é‡å®¹å™¨", priority: "high", freq: "Daily" },
                { id: "L8", title: "Lifting load not exceeding skip level", titleCN: "èµ·åŠè² è¼‰ä¸è¶…éå®¹å™¨é‚Šç·£", priority: "critical", freq: "Each Lift" },
                { id: "L9", title: "Lifting riggers and signalers stay away from fatal zone", titleCN: "èµ·é‡å·¥åŠè¨Šè™Ÿå“¡é é›¢å±éšªå€åŸŸ", priority: "critical", freq: "Each Lift" },
                { id: "L10", title: "Defective hooks replaced immediately", titleCN: "æå£åŠé‰¤ç«‹å³æ›´æ›", priority: "critical", freq: "Daily" },
                { id: "L11", title: "Retractable fall arrestor properly installed at loading point", titleCN: "ä¼¸ç¸®é˜²å¢œå™¨æ­£ç¢ºå®‰è£æ–¼åŠé»", priority: "critical", freq: "Daily" },
                { id: "L12", title: "Wire clamps installed at equal intervals and maintained", titleCN: "é‹¼çµ²ç¹©å¤¾ç­‰è·å®‰è£åŠä¿é¤Š", priority: "high", freq: "Weekly" },
                { id: "L13", title: "Lifting gear properly rested on ground when not in use", titleCN: "åŠå…·ä¸ä½¿ç”¨æ™‚å¦¥å–„æ”¾ç½®æ–¼åœ°é¢", priority: "medium", freq: "Daily" },
                { id: "L14", title: "Operator standby in cabin when engine running with suspension load", titleCN: "æ‡¸æ›è² è¼‰æ™‚æ“ä½œå“¡ç•™å®ˆé§•é§›è‰™", priority: "critical", freq: "Continuous" }
            ]},
            excavator: { name: "æŒ–æ˜æ©Ÿä½œæ¥­ / Excavator Operations", items: [
                { id: "X1", title: "Excavator bucket lowered when idling", titleCN: "æŒ–æ˜æ©Ÿæ€ é€Ÿæ™‚éŸæ–—æ”¾ä¸‹", priority: "high", freq: "Daily" },
                { id: "X2", title: "Safe access/egress for operators", titleCN: "æ“ä½œå“¡å®‰å…¨é€²å‡ºé€šé“", priority: "medium", freq: "Daily" },
                { id: "X3", title: "Side mirrors provided and maintained", titleCN: "å´è¦–é¡é…ç½®ä¸¦å¦¥å–„ç¶­è­·", priority: "high", freq: "Daily" },
                { id: "X4", title: "Rear-view camera properly installed and adjusted", titleCN: "å¾Œè¦–æ”åƒé ­å¦¥å–„å®‰è£åŠèª¿æ ¡", priority: "high", freq: "Daily" },
                { id: "X5", title: "CCTV angle adjusted for proper visibility", titleCN: "CCTVè§’åº¦èª¿æ ¡ç¢ºä¿è¦–é‡æ¸…æ™°", priority: "medium", freq: "Daily" },
                { id: "X6", title: "Headroom limit signal provided", titleCN: "é™é«˜è­¦ç¤ºä¿¡è™Ÿè¨­ç½®", priority: "high", freq: "Daily" },
                { id: "X7", title: "No smoking during plant operation", titleCN: "æ©Ÿæ¢°æ“ä½œæ™‚ç¦æ­¢å¸ç…™", priority: "critical", freq: "Continuous" }
            ]},
            piling: { name: "æ‰“æ¨ä½œæ¥­ / Piling Operations", items: [
                { id: "P1", title: "Pile casings properly secured", titleCN: "æ¨å¥—ç®¡å¦¥å–„å›ºå®š", priority: "high", freq: "Daily" },
                { id: "P2", title: "Pile openings covered", titleCN: "æ¨å­”è¦†è“‹", priority: "critical", freq: "Daily" },
                { id: "P3", title: "Piling rig operation zones fenced off", titleCN: "æ‰“æ¨æ©Ÿä½œæ¥­å€åœå°", priority: "critical", freq: "Daily" },
                { id: "P4", title: "Shut pins properly installed", titleCN: "é–éŠ·æ­£ç¢ºå®‰è£", priority: "medium", freq: "Daily" },
                { id: "P5", title: "Dust tube/cover lowered as low as possible", titleCN: "é˜²å¡µç®¡/ç½©é™è‡³æœ€ä½ä½ç½®", priority: "medium", freq: "Daily" },
                { id: "P6", title: "R-pin provided for connections", titleCN: "é€£æ¥è™•æä¾›Rå‹éŠ·", priority: "high", freq: "Daily" },
                { id: "P7", title: "Travel limit device checked by competent person", titleCN: "è¡Œç¨‹é™ä½è£ç½®ç”±åˆè³‡æ ¼äººå£«æª¢æŸ¥", priority: "critical", freq: "Weekly" },
                { id: "P8", title: "Key not remained at valve of pressure vessel", titleCN: "å£“åŠ›å®¹å™¨é–¥é–€ç„¡éºç•™é‘°åŒ™", priority: "critical", freq: "Daily" }
            ]},
            falling: { name: "é˜²å¢œç‰©ä¿è­· / Falling Objects Protection", items: [
                { id: "O1", title: "Rope nets on water tanks", titleCN: "æ°´ç®±ä¸Šè¨­ç½®ç¹©ç¶²", priority: "medium", freq: "Weekly" },
                { id: "O2", title: "Protruding bars/objects removed or guarded", titleCN: "çªå‡ºé‹¼ç­‹/ç‰©ä»¶ç§»é™¤æˆ–ä¿è­·", priority: "high", freq: "Daily" },
                { id: "O3", title: "Fall protection provided for work above 2 meters", titleCN: "2ç±³ä»¥ä¸Šå·¥ä½œæä¾›é˜²å¢œä¿è­·", priority: "critical", freq: "Daily" },
                { id: "O4", title: "Proper guardrails at platform edges", titleCN: "å¹³å°é‚Šç·£è¨­ç½®é©ç•¶è­·æ¬„", priority: "critical", freq: "Daily" },
                { id: "O5", title: "Insecure hanging objects removed or securely fixed", titleCN: "ä¸ç©©å›ºæ‡¸æ›ç‰©ä»¶ç§»é™¤æˆ–ç‰¢å›ºå›ºå®š", priority: "critical", freq: "Daily" },
                { id: "O6", title: "Hand tools equipped with tag line when working at height", titleCN: "é«˜è™•ä½œæ¥­æ‰‹å·¥å…·é…å‚™é˜²å¢œç¹©", priority: "high", freq: "Daily" }
            ]},
            ppe: { name: "å€‹äººé˜²è­·è£å‚™ / Personal Protective Equipment", items: [
                { id: "S1", title: "Eye protection used during grinding", titleCN: "æ‰“ç£¨æ™‚ä½©æˆ´çœ¼éƒ¨é˜²è­·", priority: "critical", freq: "Continuous" },
                { id: "S2", title: "Eye protection used during grout mixing", titleCN: "çŒæ¼¿æ··åˆæ™‚ä½©æˆ´çœ¼éƒ¨é˜²è­·", priority: "critical", freq: "Continuous" },
                { id: "S3", title: "Face shield provided for handling chemical substances", titleCN: "è™•ç†åŒ–å­¸ç‰©è³ªæ™‚æä¾›é¢ç½©", priority: "critical", freq: "Continuous" },
                { id: "S4", title: "PPE stored properly when not in use", titleCN: "å€‹äººé˜²è­·è£å‚™ä¸ä½¿ç”¨æ™‚å¦¥å–„å­˜æ”¾", priority: "medium", freq: "Daily" },
                { id: "S5", title: "Sunshade securely placed to prevent turnover", titleCN: "é®é™½å‚˜ç©©å›ºæ”¾ç½®é˜²æ­¢ç¿»å€’", priority: "medium", freq: "Daily" },
                { id: "S6", title: "Rigid umbrella stand provided instead of plastic barrier", titleCN: "ä½¿ç”¨å‰›æ€§å‚˜åº§è€Œéå¡‘æ–™åœæ¬„", priority: "medium", freq: "Daily" }
            ]},
            housekeeping: { name: "å ´åœ°æ•´ç† / Housekeeping", items: [
                { id: "H1", title: "Oil leaks cleaned immediately", titleCN: "æ¼æ²¹ç«‹å³æ¸…ç†", priority: "medium", freq: "Daily" },
                { id: "H2", title: "Residual fuel in hoses treated", titleCN: "è»Ÿç®¡ä¸­æ®˜ç•™ç‡ƒæ–™è™•ç†", priority: "high", freq: "Daily" },
                { id: "H3", title: "Uneven and slippery floor fixed", titleCN: "ä¸å¹³åŠæ¿•æ»‘åœ°é¢ä¿®å¾©", priority: "high", freq: "Daily" },
                { id: "H4", title: "Slippery footpath cleared", titleCN: "æ¿•æ»‘äººè¡Œé“æ¸…ç†", priority: "high", freq: "Daily" },
                { id: "H5", title: "Equipment not placed on stockpile", titleCN: "è¨­å‚™ä¸æ”¾ç½®æ–¼æ–™å †ä¸Š", priority: "medium", freq: "Daily" },
                { id: "H6", title: "Unsafe placement of materials improved", titleCN: "ä¸ç•¶ç‰©æ–™æ”¾ç½®æ”¹å–„", priority: "medium", freq: "Daily" },
                { id: "H7", title: "Objects moved away from excavation edge", titleCN: "ç‰©ä»¶ç§»é›¢æŒ–æ˜é‚Šç·£", priority: "high", freq: "Daily" },
                { id: "H8", title: "Stagnant water removed promptly", titleCN: "ç©æ°´åŠæ™‚æ¸…ç†", priority: "high", freq: "Daily" },
                { id: "H9", title: "Chemical substances storage area fenced off", titleCN: "åŒ–å­¸å“å„²å­˜å€åœå°", priority: "critical", freq: "Daily" },
                { id: "H10", title: "Sandbags provided to prevent mud water discharge to public", titleCN: "æ²™åŒ…é˜²æ­¢æ³¥æ°´æ’æ”¾è‡³å…¬å…±å€åŸŸ", priority: "high", freq: "Daily" }
            ]},
            access: { name: "é€²å‡ºé€šé“ / Access & Egress", items: [
                { id: "A1", title: "Working platforms sufficient width", titleCN: "å·¥ä½œå¹³å°å¯¬åº¦è¶³å¤ ", priority: "high", freq: "Daily" },
                { id: "A2", title: "Trapping hazards eliminated on footpaths", titleCN: "æ¶ˆé™¤é€šé“ä¸Šçš„ trapping å±éšª", priority: "medium", freq: "Daily" },
                { id: "A3", title: "Sharp edges of planking guarded", titleCN: "æœ¨æ¿éŠ³é‚Šä¿è­·", priority: "medium", freq: "Daily" },
                { id: "A4", title: "Slope edges fenced off", titleCN: "æ–œå¡é‚Šç·£åœå°", priority: "medium", freq: "Daily" },
                { id: "A5", title: "Safe access and egress maintained at all workplaces", titleCN: "æ‰€æœ‰å·¥ä½œå ´æ‰€ä¿æŒå®‰å…¨é€²å‡ºé€šé“", priority: "critical", freq: "Daily" },
                { id: "A6", title: "Ladder platform properly stored", titleCN: "æ¢¯å­å¹³å°å¦¥å–„å­˜æ”¾", priority: "medium", freq: "Daily" },
                { id: "A7", title: "Defective ladder removed from use", titleCN: "æå£æ¢¯å­ç¦æ­¢ä½¿ç”¨", priority: "critical", freq: "Daily" },
                { id: "A8", title: "Hoses relocated away from staircase", titleCN: "è»Ÿç®¡ç§»é›¢æ¨“æ¢¯", priority: "medium", freq: "Daily" },
                { id: "A9", title: "Sufficient illumination provided at workplace", titleCN: "å·¥ä½œå ´æ‰€ç…§æ˜å……è¶³", priority: "high", freq: "Daily" },
                { id: "A10", title: "Uneven metal plates fixed to prevent tripping", titleCN: "ä¸å¹³é‹¼æ¿ä¿®å¾©é˜²æ­¢çµ†å€’", priority: "high", freq: "Daily" }
            ]},
            rules: { name: "åœ°ç›¤è¦å®š / Site Rules", items: [
                { id: "R1", title: "No smoking policy enforced", titleCN: "åŸ·è¡Œç¦ç…™è¦å®š", priority: "high", freq: "Continuous" },
                { id: "R2", title: "Typhoon preventive measures taken", titleCN: "æ¡å–é¢±é¢¨é é˜²æªæ–½", priority: "high", freq: "As Required" },
                { id: "R3", title: "Smoking prohibited during operating a plant", titleCN: "æ“ä½œæ©Ÿæ¢°æ™‚ç¦æ­¢å¸ç…™", priority: "critical", freq: "Continuous" }
            ]},
            docs: { name: "æ–‡ä»¶è¨˜éŒ„ / Documentation", items: [
                { id: "D1", title: "Form 4 for excavation and earthwork displayed (competent person inspection)", titleCN: "æŒ–æ˜åŠåœŸæ–¹å·¥ç¨‹è¡¨æ ¼4å¼µè²¼åŠåˆè³‡æ ¼äººå£«æª¢æŸ¥", priority: "critical", freq: "Weekly" },
                { id: "D2", title: "Form 5 for metal scaffolding displayed (competent person details)", titleCN: "é‡‘å±¬æ£šæ¶è¡¨æ ¼5å¼µè²¼åŠåˆè³‡æ ¼äººå£«è©³æƒ…", priority: "high", freq: "Weekly" },
                { id: "D3", title: "Inspection Report Form 1 for chain block prepared", titleCN: "æ‰‹æ‹‰è‘«è˜†æª¢æŸ¥å ±å‘Šè¡¨æ ¼1å‚™å¦¥", priority: "high", freq: "Weekly" },
                { id: "D4", title: "Hot work permit properly filled with recipient name", titleCN: "ç†±å·¥åºè¨±å¯è­‰æ­£ç¢ºå¡«å¯«æ”¶ä»¶äººå§“å", priority: "critical", freq: "Daily" }
            ]},
            excavation: { name: "æŒ–æ˜èˆ‡æ–œå¡ / Excavation & Slope", items: [
                { id: "V1", title: "Rigid barriers along slope edges installed", titleCN: "æ–œå¡é‚Šç·£å®‰è£å‰›æ€§åœæ¬„", priority: "critical", freq: "Daily" },
                { id: "V2", title: "Safe angle excavation provided", titleCN: "æä¾›å®‰å…¨è§’åº¦æŒ–æ˜", priority: "critical", freq: "Daily" },
                { id: "V3", title: "Slope surface protection maintained", titleCN: "æ–œå¡è¡¨é¢ä¿è­·ç¶­è­·", priority: "high", freq: "Daily" },
                { id: "V4", title: "Excavation pit beside haul road fenced off", titleCN: "é‹è¼¸è·¯æ—æŒ–æ˜å‘åœå°", priority: "critical", freq: "Daily" },
                { id: "V5", title: "Serious wash off checked by competent person", titleCN: "åš´é‡æ²–åˆ·ç”±åˆè³‡æ ¼äººå£«æª¢æŸ¥", priority: "critical", freq: "Immediately" },
                { id: "V6", title: "Plastic barriers removed from slope", titleCN: "æ–œå¡ä¸Šå¡‘æ–™åœæ¬„ç§»é™¤", priority: "medium", freq: "Daily" }
            ]},
            material: { name: "ç‰©æ–™å„²å­˜ / Material Storage", items: [
                { id: "M1", title: "Casting properly wedged at both sides", titleCN: "é‘„ä»¶å…©å´å¦¥å–„æ¥”ç·Š", priority: "high", freq: "Daily" },
                { id: "M2", title: "Rolling objects properly wedged", titleCN: "æ»¾å‹•ç‰©ä»¶å¦¥å–„æ¥”ç·Š", priority: "high", freq: "Daily" },
                { id: "M3", title: "Damaged wedges replaced", titleCN: "æå£æ¥”å¡Šæ›´æ›", priority: "high", freq: "Daily" },
                { id: "M4", title: "Pipe rack provided for casing storage", titleCN: "å¥—ç®¡å„²å­˜æä¾›ç®¡æ¶", priority: "medium", freq: "Daily" },
                { id: "M5", title: "Opening covered for safety", titleCN: "é–‹å£è¦†è“‹ç¢ºä¿å®‰å…¨", priority: "critical", freq: "Daily" },
                { id: "M6", title: "Damaged push sticks replaced", titleCN: "æå£æ¨æ¡¿æ›´æ›", priority: "medium", freq: "Daily" },
                { id: "M7", title: "Casing and drilling rod securely fastened by webbing sling prior to transport", titleCN: "é‹è¼¸å‰å¥—ç®¡åŠé‘½æ¡¿ç”¨åŠå¸¶ç‰¢å›ºç¶ç´®", priority: "critical", freq: "Each Transport" },
                { id: "M8", title: "Wheel wedges provided to concrete truck when parking at inclined slope", titleCN: "æ··å‡åœŸè»Šæ–œå¡åœæ³Šæ™‚ä½¿ç”¨è¼ªæ“‹", priority: "critical", freq: "Daily" },
                { id: "M9", title: "Outrigger of concrete pump truck rested on ground firmly", titleCN: "æ··å‡åœŸæ³µè»Šæ”¯è…¿ç©©å›ºæ”¯æ’æ–¼åœ°é¢", priority: "critical", freq: "Each Setup" }
            ]},
            confined: { name: "å¯†é–‰ç©ºé–“ / Confined Space", items: [
                { id: "C1", title: "Lifebuoy provided at sump pit", titleCN: "é›†æ°´å‘æä¾›æ•‘ç”Ÿåœˆ", priority: "critical", freq: "Daily" },
                { id: "C2", title: "Tripping hazards eliminated near openings", titleCN: "é–‹å£é™„è¿‘çµ†å€’å±éšªæ¶ˆé™¤", priority: "high", freq: "Daily" },
                { id: "C3", title: "Gap fully covered", titleCN: "ç¸«éš™å®Œå…¨è¦†è“‹", priority: "critical", freq: "Daily" }
            ]},
            welding: { name: "ç„Šæ¥åˆ‡å‰²ä½œæ¥­ / Welding & Cutting", items: [
                { id: "W1", title: "Non-return valves provided at torch connection", titleCN: "ç„Šç‚¬é€£æ¥è™•è¨­ç½®å›ç«é˜²æ­¢é–¥", priority: "critical", freq: "Daily" },
                { id: "W2", title: "Aging gas hoses for flame cutting set replaced", titleCN: "è€åŒ–ç«ç„°åˆ‡å‰²æ°£å–‰æ›´æ›", priority: "critical", freq: "Daily" },
                { id: "W3", title: "Air hose checked and fixed by competent person when torn", titleCN: "æ°£å–‰ç ´ææ™‚ç”±åˆè³‡æ ¼äººå£«æª¢æŸ¥ä¿®å¾©", priority: "critical", freq: "Immediately" },
                { id: "W4", title: "Power cables removed from gas cylinder cage", titleCN: "é›»æºç·šç§»é›¢æ°£ç“¶ç± ", priority: "high", freq: "Daily" },
                { id: "W5", title: "Valid hot-work permit available", titleCN: "æœ‰æ•ˆç†±å·¥åºè¨±å¯è­‰å‚™å¦¥", priority: "critical", freq: "Each Operation" }
            ]}
        };

        // ==================== STATE ====================
        let selectedCategories = new Set();
        let inspectionResults = {};
        let currentCategory = null;
        let currentReportId = null;
        let currentUser = null;
        let userRole = 'inspector';
        let isOffline = false;
        let pendingSync = [];

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('inspectionDate').valueAsDate = new Date();
            generateInspectionNo();
            renderCategories();
            checkOnlineStatus();

            window.addEventListener('online', () => updateOnlineStatus(true));
            window.addEventListener('offline', () => updateOnlineStatus(false));
        });

        function generateInspectionNo() {
            const date = new Date();
            const prefix = 'INS';
            const timestamp = date.getFullYear().toString().substr(2) + 
                            String(date.getMonth() + 1).padStart(2, '0') + 
                            String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            document.getElementById('inspectionNo').value = `${prefix}-${timestamp}-${random}`;
        }

        function checkOnlineStatus() {
            updateOnlineStatus(navigator.onLine);
        }

        function updateOnlineStatus(online) {
            isOffline = !online;
            const banner = document.getElementById('offlineBanner');
            const status = document.getElementById('syncStatus');
            const icon = document.getElementById('syncIcon');
            const text = document.getElementById('syncText');

            if (online) {
                banner.classList.remove('active');
                status.className = 'sync-status online';
                icon.textContent = 'ğŸŸ¢';
                text.textContent = 'å·²é€£ç·š Online';
                syncPendingData();
            } else {
                banner.classList.add('active');
                status.className = 'sync-status offline';
                icon.textContent = 'ğŸ”´';
                text.textContent = 'é›¢ç·š Offline';
            }
        }

        // ==================== AUTHENTICATION ====================
        function selectRole(role) {
            userRole = role;
            document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-role="${role}"]`).classList.add('selected');
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!email || !password) {
                errorDiv.textContent = 'è«‹è¼¸å…¥é›»éƒµå’Œå¯†ç¢¼ Please enter email and password';
                errorDiv.style.display = 'block';
                return;
            }

            showLoading('ç™»å…¥ä¸­ Logging in...');

            if (isFirebaseInitialized) {
                auth.signInWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        currentUser = userCredential.user;
                        hideLoading();
                        showApp();
                    })
                    .catch(error => {
                        hideLoading();
                        errorDiv.textContent = error.message;
                        errorDiv.style.display = 'block';
                    });
            } else {
                setTimeout(() => {
                    hideLoading();
                    currentUser = { email: email, uid: 'offline_' + Date.now() };
                    showApp();
                }, 1000);
            }
        }

        function offlineMode() {
            isOffline = true;
            currentUser = { email: 'offline@local.com', uid: 'offline_local' };
            updateOnlineStatus(false);
            showApp();
        }

        function logout() {
            if (isFirebaseInitialized && auth.currentUser) {
                auth.signOut();
            }
            currentUser = null;
            selectedCategories.clear();
            inspectionResults = {};
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';

            const badge = document.getElementById('userBadge');
            const subtitle = document.getElementById('headerSubtitle');

            if (userRole === 'inspector') {
                badge.textContent = 'ğŸ‘· RSS';
                subtitle.textContent = 'é§åœ°å·¥ç¨‹å¸«ä»£è¡¨ Representative from RSS';
            } else {
                badge.textContent = 'ğŸ—ï¸ Contractor';
                subtitle.textContent = 'æ‰¿åŒ…å•† Contractor';
            }
        }

        // ==================== UI FUNCTIONS ====================
        function renderCategories() {
            const grid = document.getElementById('selectView');
            grid.innerHTML = '';

            Object.keys(inspectionData).forEach(key => {
                const cat = inspectionData[key];
                const card = document.createElement('div');
                card.className = 'category-card';
                card.setAttribute('data-category', key);
                card.onclick = () => selectCategory(key);

                const icons = {
                    fire: 'ğŸ”¥', electrical: 'âš¡', lifting: 'ğŸ—ï¸', excavator: 'ğŸšœ',
                    piling: 'ğŸ”©', falling: 'â›‘ï¸', ppe: 'ğŸ¥½', housekeeping: 'ğŸ§¹',
                    access: 'ğŸš¶', rules: 'ğŸ“‹', docs: 'ğŸ“„', excavation: 'â›°ï¸',
                    material: 'ğŸ“¦', confined: 'ğŸ•³ï¸', welding: 'ğŸ”¥'
                };

                card.innerHTML = `
                    <div class="check-mark">âœ“</div>
                    <div class="category-icon">${icons[key] || 'ğŸ“‹'}</div>
                    <div class="category-name">${cat.name.split(' / ')[1] || cat.name}</div>
                    <div class="category-count">${cat.items.length} é …</div>
                `;
                grid.appendChild(card);
            });
        }

        function selectCategory(category) {
            const card = document.querySelector(`[data-category="${category}"]`);
            if (selectedCategories.has(category)) {
                selectedCategories.delete(category);
                card.classList.remove('selected');
            } else {
                selectedCategories.add(category);
                card.classList.add('selected');
            }
            updateProgress();
        }

        function updateProgress() {
            let completed = 0, total = 0;
            selectedCategories.forEach(cat => {
                inspectionData[cat].items.forEach(item => {
                    total++;
                    const result = inspectionResults[item.id];
                    if (result && (result.photos?.length > 0 || result.contractorPhotos?.length > 0)) {
                        completed++;
                    }
                });
            });
            const pct = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('progressText').textContent = `${completed}/${total}`;
        }

        function showView(view) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('selectView').style.display = 'none';
            document.getElementById('inspectView').classList.remove('active');
            document.getElementById('summaryView').classList.remove('active');

            if (view === 'select') {
                document.getElementById('selectView').style.display = 'grid';
            } else if (view === 'inspect') {
                if (selectedCategories.size === 0) {
                    alert('è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹é¡åˆ¥');
                    return;
                }
                showFirstCategory();
            } else if (view === 'summary') {
                document.getElementById('summaryView').classList.add('active');
                updateSummary();
            }
        }

        function showFirstCategory() {
            const first = Array.from(selectedCategories)[0];
            if (first) showCategory(first);
        }

        function showCategory(category) {
            currentCategory = category;
            const data = inspectionData[category];
            document.getElementById('inspectTitle').textContent = data.name;
            document.getElementById('selectView').style.display = 'none';
            document.getElementById('inspectView').classList.add('active');

            let html = '';
            data.items.forEach((item, idx) => {
                const result = inspectionResults[item.id] || {};
                const photos = result.photos || [];
                const cPhotos = result.contractorPhotos || [];

                html += createItemHTML(item, idx, result, photos, cPhotos);
            });

            // Navigation
            const cats = Array.from(selectedCategories);
            const idx = cats.indexOf(category);
            html += '<div style="display: flex; gap: 10px; margin: 20px 0 40px;">';
            if (idx > 0) html += `<button class="btn btn-secondary" onclick="showCategory('${cats[idx-1]}')">â† ä¸Šä¸€é …</button>`;
            if (idx < cats.length - 1) html += `<button class="btn btn-primary" onclick="showCategory('${cats[idx+1]}')" style="margin-left: auto;">ä¸‹ä¸€é … â†’</button>`;
            else html += `<button class="btn btn-primary" onclick="completeInspection()" style="margin-left: auto;">å®Œæˆæª¢æŸ¥ âœ“</button>`;
            html += '</div>';

            document.getElementById('inspectContent').innerHTML = html;
        }

        function createItemHTML(item, idx, result, photos, cPhotos) {
            const pass = result.status === 'pass' ? 'selected' : '';
            const fail = result.status === 'fail' ? 'selected' : '';
            const na = result.status === 'na' ? 'selected' : '';

            let pHtml = photos.map((p, i) => `
                <div><div class="photo-box has-image">
                    <div class="photo-preview" style="background-image: url('${p}')"></div>
                    <button class="remove-photo" onclick="removePhoto('${item.id}', ${i}, 'inspector')">Ã—</button>
                </div><div class="photo-caption">ç…§ç‰‡ ${i+1}</div></div>
            `).join('');

            pHtml += `
                <div><div class="photo-box">
                    <label style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;z-index:5;">
                        <div class="photo-placeholder"><div class="photo-icon">+</div><div class="photo-text">æ·»åŠ ç…§ç‰‡</div></div>
                        <input type="file" accept="image/*" onchange="addPhoto('${item.id}', this, 'inspector')" style="display:none;">
                    </label>
                </div><div class="photo-caption">æ·»åŠ æ–°ç…§ç‰‡</div></div>
            `;

            let cHtml = cPhotos.map((p, i) => `
                <div><div class="photo-box has-image" style="border-color: #f59e0b;">
                    <div class="photo-preview" style="background-image: url('${p}')"></div>
                    <button class="remove-photo" onclick="removePhoto('${item.id}', ${i}, 'contractor')">Ã—</button>
                </div><div class="photo-caption">æ•´æ”¹ç…§ ${i+1}</div></div>
            `).join('');

            cHtml += `
                <div><div class="photo-box" style="border-color: #f59e0b;">
                    <label style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;z-index:5;">
                        <div class="photo-placeholder" style="color: #92400e;"><div class="photo-icon">+</div><div class="photo-text">æ·»åŠ æ•´æ”¹ç…§</div></div>
                        <input type="file" accept="image/*" onchange="addPhoto('${item.id}', this, 'contractor')" style="display:none;">
                    </label>
                </div><div class="photo-caption">æ·»åŠ æ•´æ”¹ç…§ç‰‡</div></div>
            `;

            return `
                <div class="checklist-item" data-item="${item.id}">
                    <div class="item-header">
                        <span class="item-number">${idx+1}</span>
                        <div class="item-title">${item.title}</div>
                        <div class="item-subtitle">${item.titleCN}</div>
                        <div class="badges">
                            <span class="badge ${item.priority}">${item.priority}</span>
                            <span class="badge freq">${item.freq}</span>
                        </div>
                    </div>
                    <div class="status-section">
                        <label class="status-label">ç‹€æ…‹ / Status</label>
                        <div class="status-options">
                            <div class="status-option pass ${pass}" onclick="setStatus('${item.id}', 'pass')">
                                <div class="status-icon">âœ“</div><div class="status-text">åˆæ ¼ PASS</div>
                            </div>
                            <div class="status-option fail ${fail}" onclick="setStatus('${item.id}', 'fail')">
                                <div class="status-icon">âœ—</div><div class="status-text">ä¸åˆæ ¼ FAIL</div>
                            </div>
                            <div class="status-option na ${na}" onclick="setStatus('${item.id}', 'na')">
                                <div class="status-icon">âˆ’</div><div class="status-text">ä¸é©ç”¨ N/A</div>
                            </div>
                        </div>
                    </div>
                    <div class="inspector-section">
                        <div class="section-label inspector-label">ğŸ‘· é§åœ°å·¥ç¨‹å¸«ä»£è¡¨ RSS Representative</div>
                        <div class="photo-grid">${pHtml}</div>
                        <div class="remarks-section" style="border-top: none; padding: 12px 0 0 0;">
                            <textarea class="remarks-field" placeholder="é§åœ°å·¥ç¨‹å¸«å‚™è¨»..." onchange="saveRemark('${item.id}', 'inspector', this.value)">${result.inspectorRemark || ''}</textarea>
                        </div>
                    </div>
                    <div class="contractor-section">
                        <div class="section-label contractor-label">ğŸ—ï¸ æ‰¿åŒ…å•† Contractor</div>
                        <div class="photo-grid">${cHtml}</div>
                        <div class="remarks-section" style="border-top: none; padding: 12px 0 0 0;">
                            <textarea class="remarks-field" placeholder="æ‰¿åŒ…å•†å‚™è¨»..." onchange="saveRemark('${item.id}', 'contractor', this.value)">${result.contractorRemark || ''}</textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        function setStatus(itemId, status) {
            if (!inspectionResults[itemId]) inspectionResults[itemId] = { photos: [], contractorPhotos: [] };
            inspectionResults[itemId].status = status;

            const item = document.querySelector(`[data-item="${itemId}"]`);
            item.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
            item.querySelector(`.status-option.${status}`).classList.add('selected');
            updateProgress();
        }

        function addPhoto(itemId, input, type) {
            if (!input.files || !input.files[0]) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                if (!inspectionResults[itemId]) inspectionResults[itemId] = { photos: [], contractorPhotos: [] };
                if (type === 'inspector') {
                    inspectionResults[itemId].photos.push(e.target.result);
                } else {
                    inspectionResults[itemId].contractorPhotos.push(e.target.result);
                }
                showCategory(currentCategory);
                updateProgress();
            };
            reader.readAsDataURL(input.files[0]);
        }

        function removePhoto(itemId, idx, type) {
            if (!inspectionResults[itemId]) return;
            if (type === 'inspector') {
                inspectionResults[itemId].photos.splice(idx, 1);
            } else {
                inspectionResults[itemId].contractorPhotos.splice(idx, 1);
            }
            showCategory(currentCategory);
            updateProgress();
        }

        function saveRemark(itemId, type, value) {
            if (!inspectionResults[itemId]) inspectionResults[itemId] = { photos: [], contractorPhotos: [] };
            if (type === 'inspector') {
                inspectionResults[itemId].inspectorRemark = value;
            } else {
                inspectionResults[itemId].contractorRemark = value;
            }
        }

        function completeInspection() {
            document.querySelector(`[data-category="${currentCategory}"]`)?.classList.add('completed');
            updateProgress();
            document.querySelectorAll('.mode-btn')[2].click();
        }

        function updateSummary() {
            let total = 0, pass = 0, fail = 0, na = 0;
            const issues = [];

            selectedCategories.forEach(cat => {
                inspectionData[cat].items.forEach(item => {
                    const result = inspectionResults[item.id];
                    if (result && (result.photos?.length > 0 || result.contractorPhotos?.length > 0)) {
                        total++;
                        if (result.status === 'pass') pass++;
                        else if (result.status === 'fail') {
                            fail++;
                            issues.push({ title: item.title, category: inspectionData[cat].name });
                        }
                        else if (result.status === 'na') na++;
                    }
                });
            });

            document.getElementById('totalItems').textContent = total;
            document.getElementById('passItems').textContent = pass;
            document.getElementById('failItems').textContent = fail;
            document.getElementById('naItems').textContent = na;

            const issuesCard = document.getElementById('issuesCard');
            if (issues.length > 0) {
                issuesCard.style.display = 'block';
                document.getElementById('issueList').innerHTML = issues.map(i => `
                    <div class="issue-item">
                        <div class="issue-title">${i.title}</div>
                        <div class="issue-category">${i.category}</div>
                    </div>
                `).join('');
            } else {
                issuesCard.style.display = 'none';
            }
        }

        // ==================== SAVE & SYNC ====================
        function saveToCloud() {
            if (isOffline) {
                saveToLocal();
                alert('å·²ä¿å­˜è‡³æœ¬åœ° Saved locally (Offline mode)');
                return;
            }

            showLoading('ä¿å­˜ä¸­ Saving...');

            const reportData = {
                id: document.getElementById('inspectionNo').value,
                projectName: document.getElementById('projectName').value,
                inspectorName: document.getElementById('inspectorName').value,
                contractorName: document.getElementById('contractorName').value,
                date: document.getElementById('inspectionDate').value,
                weather: document.getElementById('weather').value,
                results: inspectionResults,
                categories: Array.from(selectedCategories),
                timestamp: Date.now(),
                userId: currentUser?.uid
            };

            if (isFirebaseInitialized) {
                database.ref('inspections/' + reportData.id).set(reportData)
                    .then(() => {
                        hideLoading();
                        alert('ä¿å­˜æˆåŠŸ Saved successfully');
                    })
                    .catch(err => {
                        hideLoading();
                        saveToLocal();
                        alert('ä¿å­˜å¤±æ•—ï¼Œå·²å­˜è‡³æœ¬åœ° Save failed, stored locally');
                    });
            } else {
                setTimeout(() => {
                    hideLoading();
                    saveToLocal();
                    alert('å·²ä¿å­˜è‡³æœ¬åœ° Saved locally');
                }, 1000);
            }
        }

        function saveToLocal() {
            const data = {
                inspectionNo: document.getElementById('inspectionNo').value,
                projectName: document.getElementById('projectName').value,
                inspectorName: document.getElementById('inspectorName').value,
                contractorName: document.getElementById('contractorName').value,
                date: document.getElementById('inspectionDate').value,
                weather: document.getElementById('weather').value,
                results: inspectionResults,
                categories: Array.from(selectedCategories)
            };
            localStorage.setItem('safety_inspection_' + data.inspectionNo, JSON.stringify(data));
        }

        function syncData() {
            if (isOffline) {
                alert('é›¢ç·šæ¨¡å¼ï¼Œç„¡æ³•åŒæ­¥ Offline mode, cannot sync');
                return;
            }
            showLoading('åŒæ­¥ä¸­ Syncing...');
            setTimeout(() => {
                hideLoading();
                alert('åŒæ­¥å®Œæˆ Sync completed');
            }, 1500);
        }

        function syncPendingData() {
            // Sync local data to cloud when back online
            console.log('Syncing pending data...');
        }

        // ==================== REPORT GENERATION ====================
        function generateReport(type) {
            const reportData = {
                inspectionNo: document.getElementById('inspectionNo').value,
                projectName: document.getElementById('projectName').value,
                inspectorName: document.getElementById('inspectorName').value,
                contractorName: document.getElementById('contractorName').value,
                date: document.getElementById('inspectionDate').value,
                weather: document.getElementById('weather').value
            };

            if (type === 'pdf') {
                generatePDF(reportData);
            } else {
                generateWord(reportData);
            }
        }

        function generatePDF(data) {
            showLoading('ç”Ÿæˆ PDF ä¸­ Generating PDF...');

            const printWindow = window.open('', '_blank');
            const content = generatePrintContent(data);

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Safety Report - ${data.projectName}</title>
                    <style>
                        @page { size: A4 portrait; margin: 15mm; }
                        body { font-family: 'PingFang TC', 'Microsoft JhengHei', Arial, sans-serif; font-size: 10pt; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 3px double #000; padding-bottom: 15px; }
                        .header h1 { font-size: 16pt; margin-bottom: 5px; }
                        .header h2 { font-size: 12pt; font-weight: normal; margin-bottom: 15px; }
                        .info-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        .info-table td { border: 1px solid #000; padding: 8px; }
                        .info-table .label { background: #f0f0f0; font-weight: bold; width: 25%; }
                        .item { border: 1px solid #000; margin-bottom: 15px; page-break-inside: avoid; }
                        .item-header { background: #f5f5f5; padding: 10px; border-bottom: 1px solid #000; }
                        .item-title { font-weight: bold; font-size: 11pt; }
                        .item-subtitle { font-size: 9pt; color: #666; margin-top: 4px; }
                        .status { padding: 5px 10px; margin: 5px 0; font-weight: bold; }
                        .status.pass { background: #d4edda; color: #155724; }
                        .status.fail { background: #f8d7da; color: #721c24; }
                        .photos { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
                        .photo { border: 1px solid #ccc; page-break-inside: avoid; }
                        .photo img { width: 100%; height: auto; max-height: 150px; object-fit: contain; }
                        .section { padding: 10px; border-top: 1px solid #ddd; }
                        .section-title { font-weight: bold; margin-bottom: 8px; }
                        .inspector { background: #e3f2fd; }
                        .contractor { background: #fff3e0; }
                        .signatures { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 40px; page-break-inside: avoid; }
                        .signature { text-align: center; }
                        .signature-line { border-bottom: 1px solid #000; height: 60px; margin-bottom: 8px; }
                        .footer { margin-top: 30px; font-size: 8pt; text-align: center; color: #666; border-top: 1px solid #ccc; padding-top: 10px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>WEEKLY SAFETY INSPECTION REPORT</h1>
                        <h2>æ¯é€±å®‰å…¨æª¢æŸ¥å ±å‘Š</h2>
                        <table class="info-table">
                            <tr><td class="label">é …ç›®åç¨±<br>Project</td><td>${data.projectName || ''}</td>
                                <td class="label">æª¢æŸ¥ç·¨è™Ÿ<br>Inspection No.</td><td>${data.inspectionNo || ''}</td></tr>
                            <tr><td class="label">æª¢æŸ¥æ—¥æœŸ<br>Date</td><td>${data.date || ''}</td>
                                <td class="label">å¤©æ°£<br>Weather</td><td>${data.weather || ''}</td></tr>
                            <tr><td class="label">é§åœ°å·¥ç¨‹å¸«ä»£è¡¨<br>RSS Rep</td><td>${data.inspectorName || ''}</td>
                                <td class="label">æ‰¿åŒ…å•†ä»£è¡¨<br>Contractor Rep</td><td>${data.contractorName || ''}</td></tr>
                        </table>
                    </div>
                    ${content}
                    <div class="signatures">
                        <div class="signature">
                            <div class="signature-line"></div>
                            <div><strong>é§åœ°å·¥ç¨‹å¸«ä»£è¡¨<br>RSS Representative</strong></div>
                            <div style="font-size: 9pt; color: #666; margin-top: 5px;">Date: ${data.date || ''}</div>
                        </div>
                        <div class="signature">
                            <div class="signature-line"></div>
                            <div><strong>æ‰¿åŒ…å•†å®‰å…¨ä»£è¡¨åŠå®‰å…¨ç¶“ç†<br>Contractor Safety Rep & Safety Manager</strong></div>
                            <div style="font-size: 9pt; color: #666; margin-top: 5px;">Date: _____________</div>
                        </div>
                    </div>
                    <div class="footer">
                        <div>This report is generated electronically and is valid without signature.</div>
                        <div>æœ¬å ±å‘Šä»¥é›»å­æ–¹å¼ç”Ÿæˆï¼Œç„¡éœ€ç°½ç½²å³ç‚ºæœ‰æ•ˆã€‚</div>
                        <div>Generated: ${new Date().toLocaleString()}</div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();

            setTimeout(() => {
                hideLoading();
                printWindow.focus();
                printWindow.print();
            }, 500);
        }

        function generateWord(data) {
            const content = generatePrintContent(data);
            const html = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset="utf-8"><title>Safety Report</title></head>
                <body>
                    <h1>WEEKLY SAFETY INSPECTION REPORT / æ¯é€±å®‰å…¨æª¢æŸ¥å ±å‘Š</h1>
                    <table border="1" style="width:100%; border-collapse: collapse;">
                        <tr><td style="background:#f0f0f0; padding:8px;"><b>é …ç›®åç¨± Project</b></td><td>${data.projectName || ''}</td>
                            <td style="background:#f0f0f0; padding:8px;"><b>æª¢æŸ¥ç·¨è™Ÿ Inspection No.</b></td><td>${data.inspectionNo || ''}</td></tr>
                        <tr><td style="background:#f0f0f0; padding:8px;"><b>æ—¥æœŸ Date</b></td><td>${data.date || ''}</td>
                            <td style="background:#f0f0f0; padding:8px;"><b>å¤©æ°£ Weather</b></td><td>${data.weather || ''}</td></tr>
                        <tr><td style="background:#f0f0f0; padding:8px;"><b>é§åœ°å·¥ç¨‹å¸«ä»£è¡¨ RSS Rep</b></td><td>${data.inspectorName || ''}</td>
                            <td style="background:#f0f0f0; padding:8px;"><b>æ‰¿åŒ…å•†ä»£è¡¨ Contractor Rep</b></td><td>${data.contractorName || ''}</td></tr>
                    </table>
                    <br>
                    ${content}
                    <br><br>
                    <table style="width:100%;">
                        <tr>
                            <td style="width:50%; text-align: center;">
                                <div style="border-bottom: 1px solid #000; height: 60px;"></div>
                                <b>é§åœ°å·¥ç¨‹å¸«ä»£è¡¨ RSS Representative</b><br>
                                Date: ${data.date || ''}
                            </td>
                            <td style="width:50%; text-align: center;">
                                <div style="border-bottom: 1px solid #000; height: 60px;"></div>
                                <b>æ‰¿åŒ…å•†å®‰å…¨ä»£è¡¨åŠå®‰å…¨ç¶“ç†<br>Contractor Safety Rep & Safety Manager</b><br>
                                Date: _____________
                            </td>
                        </tr>
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Safety_Report_${data.inspectionNo || 'export'}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generatePrintContent(data) {
            let html = '';
            selectedCategories.forEach(cat => {
                const catData = inspectionData[cat];
                html += `<h3 style="color: #1e40af; border-bottom: 2px solid #1e40af; padding-bottom: 5px;">${catData.name}</h3>`;

                catData.items.forEach((item, idx) => {
                    const result = inspectionResults[item.id] || {};
                    const status = result.status || 'Not checked';
                    const statusClass = status === 'pass' ? 'pass' : status === 'fail' ? 'fail' : '';
                    const statusText = status === 'pass' ? 'åˆæ ¼ PASS' : status === 'fail' ? 'ä¸åˆæ ¼ FAIL' : status === 'na' ? 'ä¸é©ç”¨ N/A' : 'æœªæª¢æŸ¥';

                    let photosHtml = '';
                    if (result.photos?.length > 0) {
                        photosHtml += `<div class="photos">`;
                        result.photos.forEach(p => {
                            photosHtml += `<div class="photo"><img src="${p}"></div>`;
                        });
                        photosHtml += `</div>`;
                    }

                    let cPhotosHtml = '';
                    if (result.contractorPhotos?.length > 0) {
                        cPhotosHtml += `<div class="photos">`;
                        result.contractorPhotos.forEach(p => {
                            cPhotosHtml += `<div class="photo"><img src="${p}"></div>`;
                        });
                        cPhotosHtml += `</div>`;
                    }

                    html += `
                        <div class="item">
                            <div class="item-header">
                                <div class="item-title">${idx + 1}. ${item.title}</div>
                                <div class="item-subtitle">${item.titleCN}</div>
                            </div>
                            <div style="padding: 10px;">
                                <div class="status ${statusClass}">ç‹€æ…‹ Status: ${statusText}</div>
                            </div>
                            <div class="section inspector">
                                <div class="section-title">ğŸ‘· RSS Representative</div>
                                ${photosHtml}
                                ${result.inspectorRemark ? `<div style="padding: 8px; background: white; margin-top: 8px; border: 1px solid #ddd;"><b>å‚™è¨»:</b> ${result.inspectorRemark}</div>` : ''}
                            </div>
                            <div class="section contractor">
                                <div class="section-title">ğŸ—ï¸ Contractor</div>
                                ${cPhotosHtml}
                                ${result.contractorRemark ? `<div style="padding: 8px; background: white; margin-top: 8px; border: 1px solid #ddd;"><b>å‚™è¨»:</b> ${result.contractorRemark}</div>` : '<div style="padding: 8px; background: white; margin-top: 8px; border: 1px solid #ddd; min-height: 40px;"><b>å‚™è¨»:</b> </div>'}
                            </div>
                        </div>
                    `;
                });
            });
            return html;
        }

        function shareReport() {
            const reportId = document.getElementById('inspectionNo').value;
            const shareUrl = `${window.location.origin}${window.location.pathname}?report=${reportId}`;

            if (navigator.share) {
                navigator.share({
                    title: 'Safety Inspection Report',
                    text: `Inspection Report: ${reportId}`,
                    url: shareUrl
                });
            } else {
                prompt('Copy this link to share:', shareUrl);
            }
        }

        // ==================== UTILITIES ====================
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function resetInspection() {
            if (!confirm('é‡ç½®æ‰€æœ‰è³‡æ–™ï¼ŸReset all data?')) return;

            selectedCategories.clear();
            inspectionResults = {};
            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected', 'completed'));
            document.getElementById('projectName').value = '';
            document.getElementById('inspectorName').value = '';
            document.getElementById('contractorName').value = '';
            document.getElementById('weather').value = '';
            generateInspectionNo();
            updateProgress();
            showView('select');
        }
    </script>
</body>
</html>
